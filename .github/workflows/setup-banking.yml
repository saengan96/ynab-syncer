name: "Initialize Bank Connection"

on:
  workflow_dispatch:
    inputs:
      bank_id:
        description: 'Bank ID (bank_of_cyprus, revolut, or eurobank_cy)'
        required: true
        default: 'bank_of_cyprus'

jobs:
  get-link:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Requirements
        run: pip install pyjwt cryptography requests

      - name: Generate Auth Link
        env:
          EB_APP_ID: ${{ secrets.EB_APP_ID }}
          EB_PRIVATE_KEY: ${{ secrets.EB_PRIVATE_KEY }}
        run: |
          python -c "
          import os, time, jwt, requests, uuid
          from cryptography.hazmat.primitives import serialization

          # 1. Load the Secret Data
          app_id = os.getenv('EB_APP_ID')
          raw_key = os.getenv('EB_PRIVATE_KEY', '').strip()

          try:
              # We load the key as an OBJECT, which PyJWT prefers
              private_key_obj = serialization.load_pem_private_key(
                  raw_key.encode(), 
                  password=None
              )
          except Exception as e:
              print(f'Key Parsing Error: {e}')
              exit(1)

          # 2. Create the Security Token
          iat = int(time.time())
          payload = {
              'iss': 'enablebanking.com',
              'aud': 'api.enablebanking.com',
              'iat': iat,
              'exp': iat + 3600
          }
          
          # We pass the OBJECT (private_key_obj) directly here
          token = jwt.encode(
              payload, 
              private_key_obj, 
              algorithm='RS256', 
              headers={'kid': app_id}
          )

          # 3. Request the Login Link
          headers = {
              'Authorization': f'Bearer {token}', 
              'Content-Type': 'application/json'
          }
          body = {
              'aspsp': {'name': '${{ github.event.inputs.bank_id }}', 'country': 'CY'},
              'state': str(uuid.uuid4()),
              'redirect_url': 'https://localhost',
              'psu_type': 'personal'
          }

          r = requests.post('https://api.enablebanking.com/auth', json=body, headers=headers)
          
          if r.status_code == 200:
              print('\n' + '='*50)
              print('LINK: ' + r.json().get('url'))
              print('='*50)
          else:
              print(f'Error {r.status_code}: {r.text}')
          "
