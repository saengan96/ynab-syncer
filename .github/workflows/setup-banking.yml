name: "Initialize Bank Connection"

on:
  workflow_dispatch:
    inputs:
      bank_id:
        description: 'Bank ID (bank_of_cyprus, revolut, or eurobank_cy)'
        required: true
        default: 'bank_of_cyprus'

jobs:
  get-link:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Requirements
        run: pip install pyjwt cryptography requests

      - name: Generate Auth Link
        env:
          EB_APP_ID: ${{ secrets.EB_APP_ID }}
          EB_PRIVATE_KEY: ${{ secrets.EB_PRIVATE_KEY }}
        run: |
          python -c "
          import os, time, jwt, requests, uuid, base64
          from cryptography.hazmat.primitives import serialization

          app_id = os.getenv('EB_APP_ID')
          raw_val = os.getenv('EB_PRIVATE_KEY', '').strip()
          
          # Detect if the user used the Base64 trick or raw text
          try:
              if not raw_val.startswith('-----'):
                  key_data = base64.b64decode(raw_val)
              else:
                  key_data = raw_val.encode()
              
              key_obj = serialization.load_pem_private_key(key_data, password=None)
              private_key_pem = key_obj.private_bytes(
                  encoding=serialization.Encoding.PEM,
                  format=serialization.PrivateFormat.TraditionalOpenSSL,
                  encryption_algorithm=serialization.NoEncryption()
              )
          except Exception as e:
              print(f'Key Error: {e}')
              exit(1)

          iat = int(time.time())
          payload = {'iss': 'enablebanking.com', 'aud': 'api.enablebanking.com', 'iat': iat, 'exp': iat + 3600}
          token = jwt.encode(payload, private_key_pem, algorithm='RS256', headers={'kid': app_id})

          headers = {'Authorization': f'Bearer {token}', 'Content-Type': 'application/json'}
          body = {
              'aspsp': {'name': '${{ github.event.inputs.bank_id }}', 'country': 'CY'},
              'state': str(uuid.uuid4()),
              'redirect_url': 'https://localhost',
              'psu_type': 'personal'
          }

          r = requests.post('https://api.enablebanking.com/auth', json=body, headers=headers)
          print('\n' + '='*50 + '\nLINK: ' + r.json().get('url', 'Error: ' + r.text) + '\n' + '='*50)
          "
