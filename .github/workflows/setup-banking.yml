name: "Initialize Bank Connection"

on:
  workflow_dispatch:
    inputs:
      bank_id:
        description: 'Bank ID (bank_of_cyprus, revolut, or eurobank_cy)'
        required: true
        default: 'bank_of_cyprus'

jobs:
  get-link:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Requirements
        run: pip install pyjwt cryptography requests

      - name: Generate Auth Link
        env:
          EB_APP_ID: ${{ secrets.EB_APP_ID }}
          EB_PRIVATE_KEY: ${{ secrets.EB_PRIVATE_KEY }}
        run: |
          python -c "
          import os, time, jwt, requests, uuid

          # 1. Load and clean the key
          app_id = os.getenv('EB_APP_ID')
          raw_key = os.getenv('EB_PRIVATE_KEY', '').strip()
          
          # Fix common formatting issues if they exist
          if not raw_key.startswith('-----BEGIN'):
              print('Error: Your key doesn\'t start with -----BEGIN RSA PRIVATE KEY-----')
              exit(1)
          
          # 2. Create the Security Token (JWT)
          iat = int(time.time())
          payload = {
              'iss': 'enablebanking.com',
              'aud': 'api.enablebanking.com',
              'iat': iat,
              'exp': iat + 3600
          }
          
          # Headers must include 'kid' (Key ID) which is your App ID
          token = jwt.encode(payload, raw_key, algorithm='RS256', headers={'kid': app_id})

          # 3. Ask Enable Banking for a Login Link
          headers = {
              'Authorization': f'Bearer {token}', 
              'Content-Type': 'application/json'
          }
          body = {
              'aspsp': {'name': '${{ github.event.inputs.bank_id }}', 'country': 'CY'},
              'state': str(uuid.uuid4()),
              'redirect_url': 'https://localhost',
              'psu_type': 'personal'
          }

          response = requests.post('https://api.enablebanking.com/auth', json=body, headers=headers)
          
          if response.status_code == 200:
              url = response.json().get('url')
              print('\n' + '='*50)
              print('SUCCESS! OPEN THIS LINK IN YOUR BROWSER:')
              print(url)
              print('='*50)
          else:
              print(f'Error {response.status_code}: {response.text}')
          "
