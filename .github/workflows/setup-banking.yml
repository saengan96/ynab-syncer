name: "Initialize Bank Connection"

on:
  workflow_dispatch:
    inputs:
      bank_id:
        description: 'Bank ID (bank_of_cyprus, revolut, or eurobank_cy)'
        required: true
        default: 'bank_of_cyprus'

jobs:
  get-link:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Requirements
        run: pip install cryptography requests

      - name: Generate Auth Link
        env:
          EB_APP_ID: ${{ secrets.EB_APP_ID }}
          EB_PRIVATE_KEY: ${{ secrets.EB_PRIVATE_KEY }}
        run: |
          python -c "
          import os, time, json, base64, requests, uuid
          from cryptography.hazmat.primitives import serialization, hashes
          from cryptography.hazmat.primitives.asymmetric import padding

          def b64url(data):
              return base64.urlsafe_b64encode(data).rstrip(b'=').decode('utf-8')

          # 1. Load the Key
          app_id = os.getenv('EB_APP_ID')
          raw_key = os.getenv('EB_PRIVATE_KEY', '').strip().encode('utf-8')
          
          try:
              private_key = serialization.load_pem_private_key(raw_key, password=None)
          except Exception as e:
              print(f'Key Loading Error: {e}')
              exit(1)

          # 2. Build JWT Manually (Header + Payload)
          header = b64url(json.dumps({'alg': 'RS256', 'typ': 'JWT', 'kid': app_id}).encode('utf-8'))
          iat = int(time.time())
          payload = b64url(json.dumps({
              'iss': 'enablebanking.com',
              'aud': 'api.enablebanking.com',
              'iat': iat,
              'exp': iat + 3600
          }).encode('utf-8'))
          
          # 3. Sign Manually
          message = f'{header}.{payload}'.encode('utf-8')
          signature = b64url(private_key.sign(message, padding.PKCS1v15(), hashes.SHA256()))
          token = f'{header}.{payload}.{signature}'

          # 4. API Request
          headers = {'Authorization': f'Bearer {token}', 'Content-Type': 'application/json'}
          body = {
              'aspsp': {'name': '${{ github.event.inputs.bank_id }}', 'country': 'CY'},
              'state': str(uuid.uuid4()),
              'redirect_url': 'https://localhost',
              'psu_type': 'personal'
          }

          r = requests.post('https://api.enablebanking.com/auth', json=body, headers=headers)
          
          if r.status_code == 200:
              print('\n' + '='*50 + '\nSUCCESS! OPEN THIS LINK:\n' + r.json().get('url') + '\n' + '='*50)
          else:
              print(f'Error {r.status_code}: {r.text}')
          "
